(function(){"use strict";const P=(s,h,I,m=5)=>{const u=[...new Array(h*s)].map((r,t)=>t),c=[...new Array(h*s)].map((r,t)=>[t]),g=[u];let f=1;const M=(r,t,d=1)=>{const i=Math.floor(r.length/s);let o=r[t];for(let n=0;n<i;++n){const a=n*s+t;let e=0;if(d<0){const l=a+s;e=l>=s*i?o:r[l]}else e=n===0?r[(i-1)*s+t]:o,o=r[a];r[a]=e,c[e][f]=a}},w=(r,t,d=1)=>{let i=r[s*t];for(let o=0;o<s;++o){const n=t*s+o;let a=0;if(d<0){const e=n+1;a=e%s===0?i:r[e]}else a=o===0?r[(t+1)*s-1]:i,i=r[n];r[n]=a,c[a][f]=n}},x=[...new Array(h)].map(()=>Math.round(Math.random()*m*2)-m),p=[...new Array(s)].map(()=>Math.round(Math.random()*2*m)-m);for(;f<I;){const r=[...g[f-1]];for(let t=0;t<s;++t)f%p[t]===0&&M(r,t,p[t]);for(let t=0;t<h;++t){f%x[t]===0&&w(r,t,x[t]);for(let d=0;d<s;++d){const i=t*s+d;c[i][f]===void 0&&(c[i][f]=c[i][f-1])}}g.push(r),f++}return c};onmessage=s=>{const{columns:h,rows:I,palette:m,visibility:u,targets:c,initialFrame:g,isProgressive:f,processId:M}=s.data,w=c.length*u+1;postMessage({processId:M,frameCount:w});let x=0;const p=[],r=new Set,t=[];let d=0;const i=P(h,I,w,10);for(let o=0;o<w;o++){o>c[x].frame&&x<c.length&&(f&&(postMessage({processId:M,targetFrames:t.slice(d,o)}),d=o),r.clear(),x+=1);const n=c[x],a=[];for(let e=0;e<h*I;++e){const l=i[e][o],F=i[e][n.frame],y=F%h,A=(F-y)/h,C=n.data[y-n.startX+(A-n.startY)*n.columns];if(o!==0&&C!==255&&y>=n.startX&&y<n.startX+n.columns&&A>=n.startY&&A<n.startY+n.rows){if(r.has(e)){a[l]=C;continue}else if(o===n.frame||Math.random()<2/u){p[e]=a[l]=C,r.add(e);continue}}p[e]===void 0?p[e]=a[l]=g?g[l]:Math.floor(Math.random()*m.length):g&&p[e]!==g[e]&&Math.random()<.05?a[l]=p[e]=g[e]:a[l]=p[e]}t.push(a.map(e=>{const l=m[e];return l||console.log(e),[parseInt(l.slice(1,3),16)/255,parseInt(l.slice(3,5),16)/255,parseInt(l.slice(5,7),16)/255]}))}postMessage({processId:M,targetFrames:t.slice(d),isFinished:!0})}})();
