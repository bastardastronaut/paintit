(function(){"use strict";const P=(a,d,C,p=5)=>{const I=[...new Array(d*a)].map((n,t)=>t),f=[...new Array(d*a)].map((n,t)=>[t]),m=[I];let l=1;const M=(n,t,c=1)=>{const o=Math.floor(n.length/a);let r=n[t];for(let i=0;i<o;++i){const e=i*a+t;let s=0;if(c<0){const w=e+a;s=w>=a*o?r:n[w]}else s=i===0?n[(o-1)*a+t]:r,r=n[e];n[e]=s,f[s][l]=e}},x=(n,t,c=1)=>{let o=n[a*t];for(let r=0;r<a;++r){const i=t*a+r;let e=0;if(c<0){const s=i+1;e=s%a===0?o:n[s]}else e=r===0?n[(t+1)*a-1]:o,o=n[i];n[i]=e,f[e][l]=i}},h=[...new Array(d)].map(()=>Math.round(Math.random()*p*2)-p),g=[...new Array(a)].map(()=>Math.round(Math.random()*2*p)-p);for(;l<C;){const n=[...m[l-1]];for(let t=0;t<a;++t)l%g[t]===0&&M(n,t,g[t]);for(let t=0;t<d;++t){l%h[t]===0&&x(n,t,h[t]);for(let c=0;c<a;++c){const o=t*a+c;f[o][l]===void 0&&(f[o][l]=f[o][l-1])}}m.push(n),l++}return f};onmessage=a=>{const{columns:d,rows:C,palette:p,visibility:I,targets:f,initialFrame:m,isProgressive:l}=a.data,M=f.length*I+1;postMessage(M);let x=0;const h=[],g=new Set,n=[];let t=0;const c=P(d,C,M,10);for(let o=0;o<M;o++){o>f[x].frame&&x<f.length&&(l&&(postMessage(n.slice(t,o)),t=o),g.clear(),x+=1);const r=f[x],i=[];for(let e=0;e<d*C;++e){const s=c[e][o],w=c[e][r.frame],u=w%d,y=(w-u)/d,A=r.data[u-r.startX+(y-r.startY)*r.columns];if(A!==255&u>=r.startX&&u<r.startX+r.columns&&y>=r.startY&&y<r.startY+r.rows){if(g.has(e)){i[s]=A;continue}else if(o===r.frame||Math.random()<2/I){h[e]=i[s]=A,g.add(e);continue}}h[e]===void 0?h[e]=i[s]=m?m[s]:Math.floor(Math.random()*p.length):h[e]!==r.baseColor&&Math.random()<.01?i[s]=h[e]=r.baseColor:i[s]=h[e]}n.push(i.map(e=>{const s=p[e];return s||console.log(e),[parseInt(s.slice(1,3),16)/255,parseInt(s.slice(3,5),16)/255,parseInt(s.slice(5,7),16)/255]}))}postMessage(n.slice(t))}})();
