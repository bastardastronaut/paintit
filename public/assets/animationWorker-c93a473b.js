(function(){"use strict";const R=(o,g,P,u=5)=>{const y=[...new Array(g*o)].map((e,t)=>t),f=[...new Array(g*o)].map((e,t)=>[t]),x=[y];let l=1;const M=(e,t,c=1)=>{const a=Math.floor(e.length/o);let d=e[t];for(let s=0;s<a;++s){const i=s*o+t;let r=0;if(c<0){const m=i+o;r=m>=o*a?d:e[m]}else r=s===0?e[(a-1)*o+t]:d,d=e[i];e[i]=r,f[r][l]=i}},I=(e,t,c=1)=>{let a=e[o*t];for(let d=0;d<o;++d){const s=t*o+d;let i=0;if(c<0){const r=s+1;i=r%o===0?a:e[r]}else i=d===0?e[(t+1)*o-1]:a,a=e[s];e[s]=i,f[i][l]=s}},w=[...new Array(g)].map(()=>Math.round(Math.random()*u*2)-u),h=[...new Array(o)].map(()=>Math.round(Math.random()*2*u)-u);for(;l<P;){const e=[...x[l-1]];for(let t=0;t<o;++t)l%h[t]===0&&M(e,t,h[t]);for(let t=0;t<g;++t){l%w[t]===0&&I(e,t,w[t]);for(let c=0;c<o;++c){const a=t*o+c;f[a][l]===void 0&&(f[a][l]=f[a][l-1])}}x.push(e),l++}return f};onmessage=o=>{const{columns:g,rows:P,palette:u,visibility:y,targets:f,initialFrame:x,isProgressive:l,processId:M}=o.data,I=f.length*y+1;postMessage({processId:M,frameCount:I});let w=0;const h=[],e=new Set,t=[];let c=0,a=33;postMessage({processId:M,progress:5});const d=R(g,P,I,10);postMessage({processId:M,progress:25});for(let s=0;s<I;s++){const i=Math.round(100*s/I);i>a&&(postMessage({processId:M,progress:i}),a=i),s>f[w].frame&&w<f.length&&(l&&(postMessage({processId:M,targetFrames:t.slice(c,s)}),c=s),e.clear(),w+=1);const r=f[w],m=[];for(let n=0;n<g*P;++n){const p=d[n][s],j=d[n][r.frame],A=j%g,C=(j-A)/g,F=r.data[A-r.startX+(C-r.startY)*r.columns];if(s!==0&&F!==255&&A>=r.startX&&A<r.startX+r.columns&&C>=r.startY&&C<r.startY+r.rows){if(e.has(n)){m[p]=F;continue}else if(s===r.frame||Math.random()<2/y){h[n]=m[p]=F,e.add(n);continue}}h[n]===void 0?h[n]=m[p]=x?x[p]:Math.floor(Math.random()*u.length):x&&h[n]!==x[n]&&Math.random()<.05?m[p]=h[n]=x[n]:m[p]=h[n]}t.push(m.map(n=>{const p=u[n];return[parseInt(p.slice(1,3),16)/255,parseInt(p.slice(3,5),16)/255,parseInt(p.slice(5,7),16)/255]}))}postMessage({processId:M,targetFrames:t.slice(c),isFinished:!0})}})();
